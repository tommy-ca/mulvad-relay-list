name: Proxy Pipeline

'on':
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      countries:
        description: 'Whitespace-separated country filters (optional)'
        required: false
      providers_allow:
        description: 'Comma-separated provider allow-list (optional)'
        required: false
      limit:
        description: 'Relay limit override (optional)'
        required: false
      verify:
        description: 'Run proxy verification after pipeline'
        required: false
        default: false
        type: boolean
      emit_canonical:
        description: 'Emit canonical Mullvad JSON artifact'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  proxy-pipeline:
    concurrency:
      group: mullvad-relay-pipeline
      cancel-in-progress: false
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up uv
        uses: astral-sh/setup-uv@v2

      - name: Install dependencies
        run: uv sync

      - name: Resolve pipeline arguments
        id: resolve
        shell: bash
        run: |
          args=("--no-cache" "--output-dir" "build" "--verbose")

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ -n "${{ github.event.inputs.countries }}" ]]; then
              args+=("--countries" "${{ github.event.inputs.countries }}")
            fi
            if [[ -n "${{ github.event.inputs.providers_allow }}" ]]; then
              args+=("--providers-allow" "${{ github.event.inputs.providers_allow }}")
            fi
            if [[ -n "${{ github.event.inputs.limit }}" ]]; then
              args+=("--limit" "${{ github.event.inputs.limit }}")
            fi
            if [[ '${{ github.event.inputs.emit_canonical }}' == 'true' ]]; then
              args+=("--emit-canonical-json")
            fi
          fi

          printf 'args=%s\n' "${args[*]}" >> "$GITHUB_OUTPUT"
          printf 'Pipeline arguments: %s\n' "${args[*]}"

          verify="false"
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && '${{ github.event.inputs.verify }}' == 'true' ]]; then
            verify="true"
          fi
          printf 'verify=%s\n' "$verify" >> "$GITHUB_OUTPUT"

          if [[ -n "$GITHUB_RUN_ATTEMPT" && "$GITHUB_RUN_ATTEMPT" -gt 1 ]]; then
            echo "Run attempt $GITHUB_RUN_ATTEMPT waiting for prior execution to finish" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Run relay pipeline
        run: uv run python build_relay_list.py ${{ steps.resolve.outputs.args }}

      - name: Run verification probes
        if: steps.resolve.outputs.verify == 'true'
        run: |
          uv run python scripts/verify_proxies.py --json build/mullvad_relays.json --limit 5

      - name: Export CSV artifact
        run: uv run python scripts/export_relays_csv.py build/mullvad_relays.json build/mullvad_relays.csv

      - name: Generate manifest
        env:
          PIPELINE_TRIGGER: ${{ github.event_name }}
          PIPELINE_RUN_ID: ${{ github.run_id }}
          PIPELINE_RUN_NUMBER: ${{ github.run_number }}
          INPUT_COUNTRIES: ${{ github.event.inputs.countries }}
          INPUT_PROVIDERS_ALLOW: ${{ github.event.inputs.providers_allow }}
          INPUT_LIMIT: ${{ github.event.inputs.limit }}
          INPUT_VERIFY: ${{ github.event.inputs.verify }}
          INPUT_EMIT_CANONICAL: ${{ github.event.inputs.emit_canonical }}
          VERIFY_ENABLED: ${{ steps.resolve.outputs.verify }}
        run: |
          uv run python - <<'PY'
          from pathlib import Path
          import json
          import os
          from mullvad.output import write_manifest

          relays_path = Path("build/mullvad_relays.json")
          relays = json.loads(relays_path.read_text(encoding="utf-8"))

          metadata = {
              "trigger": os.environ.get("PIPELINE_TRIGGER", "unknown"),
              "run_id": os.environ.get("PIPELINE_RUN_ID"),
              "run_number": os.environ.get("PIPELINE_RUN_NUMBER"),
          }
          if metadata["trigger"] == "workflow_dispatch":
              metadata["inputs"] = {
                  "countries": os.environ.get("INPUT_COUNTRIES", ""),
                  "providers_allow": os.environ.get("INPUT_PROVIDERS_ALLOW", ""),
                  "limit": os.environ.get("INPUT_LIMIT", ""),
                  "verify": os.environ.get("INPUT_VERIFY", ""),
                  "emit_canonical": os.environ.get("INPUT_EMIT_CANONICAL", ""),
              }

          write_manifest(
              relays,
              Path("build/manifest.json"),
              filters={},
              verification={"enabled": os.environ.get("VERIFY_ENABLED", "false") == "true"},
              artifacts={
                  "json": relays_path,
                  "text": Path("build/mullvad_relays.txt"),
                  "pac": Path("build/mullvad_relays.pac"),
                  "csv": Path("build/mullvad_relays.csv"),
              },
              metadata=metadata,
          )
          PY

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mullvad-relay-artifacts
          path: |
            build/mullvad_relays.json
            build/mullvad_relays.txt
            build/mullvad_relays.pac
            build/mullvad_relays.csv
            build/manifest.json
          retention-days: 7

      - name: Summarise run
        env:
          PIPELINE_TRIGGER: ${{ github.event_name }}
          RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          ARTIFACT_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts
          VERIFY_FLAG: ${{ steps.resolve.outputs.verify }}
          INPUT_COUNTRIES: ${{ github.event.inputs.countries }}
          INPUT_PROVIDERS_ALLOW: ${{ github.event.inputs.providers_allow }}
          INPUT_LIMIT: ${{ github.event.inputs.limit }}
        shell: bash
        run: |
          relay_count=$(jq 'length' build/mullvad_relays.json)
          {
            echo "### Proxy Pipeline Summary"
            echo "- Trigger: \\`$PIPELINE_TRIGGER\\`"
            echo "- Relay count: $relay_count"
            if [[ -n "$INPUT_COUNTRIES" || -n "$INPUT_PROVIDERS_ALLOW" || -n "$INPUT_LIMIT" ]]; then
              echo "- Filter overrides:"
              [[ -n "$INPUT_COUNTRIES" ]] && echo "  - Countries: $INPUT_COUNTRIES"
              [[ -n "$INPUT_PROVIDERS_ALLOW" ]] && echo "  - Providers allow: $INPUT_PROVIDERS_ALLOW"
              [[ -n "$INPUT_LIMIT" ]] && echo "  - Limit: $INPUT_LIMIT"
            fi
            if [[ "$VERIFY_FLAG" == "true" ]]; then
              echo "- Verification: enabled (see workflow logs for results)"
            else
              echo "- Verification: disabled"
            fi
            echo "- Artifact bundle: [View artifacts]($ARTIFACT_URL)"
            echo "- Workflow run: [View run]($RUN_URL)"
          } >> "$GITHUB_STEP_SUMMARY"
  publish-artifacts:
    needs: proxy-pipeline
    if: github.ref == 'refs/heads/main' && needs.proxy-pipeline.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Guard publication credentials
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ -z "$GITHUB_TOKEN" ]]; then
            echo "GITHUB_TOKEN is required for publication" >&2
            exit 1
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: mullvad-relay-artifacts
          path: publish

      - name: Configure git
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email '41898282+github-actions[bot]@users.noreply.github.com'

      - name: Prepare publication branch
        id: publish
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_ACTOR: ${{ github.actor }}
        run: |
          git remote set-url origin https://$GITHUB_ACTOR:$GITHUB_TOKEN@github.com/$GITHUB_REPOSITORY.git
          git fetch origin proxy-artifacts:proxy-artifacts || git branch proxy-artifacts
          git checkout proxy-artifacts || git checkout -b proxy-artifacts
          rm -f relays.json relays.txt relays.pac relays.csv manifest.json

          artifact_dir=$(find publish -type f -name 'mullvad_relays.json' -printf '%h' -quit)
          if [[ -z "$artifact_dir" ]]; then
            echo "Artifact files not found after download" >&2
            exit 1
          fi
          cp "$artifact_dir/mullvad_relays.json" relays.json
          cp "$artifact_dir/mullvad_relays.txt" relays.txt
          cp "$artifact_dir/mullvad_relays.pac" relays.pac
          cp "$artifact_dir/mullvad_relays.csv" relays.csv
          cp "$artifact_dir/manifest.json" manifest.json
          git add relays.json relays.txt relays.pac relays.csv manifest.json
          if git diff --cached --quiet; then
            echo "No artifact updates detected" >> "$GITHUB_STEP_SUMMARY"
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            git commit -m "chore(publish): update relay artifacts"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Push publication branch
        if: steps.publish.outputs.changed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_ACTOR: ${{ github.actor }}
        run: |
          git push --force-with-lease origin HEAD:proxy-artifacts
          echo "Published artifacts to proxy-artifacts branch" >> "$GITHUB_STEP_SUMMARY"

      - name: Update hourly release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          ARTIFACT_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts
        run: |
          set -eo pipefail

          git fetch origin proxy-artifacts
          git checkout proxy-artifacts
          target_commit=$(git rev-parse HEAD)

          body=$(cat <<'EOF'
          ### Hourly Proxy Pipeline
          - Workflow run: RUN_URL
          - Artifact bundle: ARTIFACT_URL
          EOF
          )
          body=${body/RUN_URL/$RUN_URL}
          body=${body/ARTIFACT_URL/$ARTIFACT_URL}

          api_base="https://api.github.com/repos/$GITHUB_REPOSITORY"
          release_tag="hourly-latest"

          existing_status=$(curl -s -o release.json -w "%{http_code}" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "$api_base/releases/tags/$release_tag" || true)

          if [[ "$existing_status" == "200" ]]; then
            release_id=$(jq -r '.id' release.json)
            curl -s -X PATCH \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "$api_base/releases/$release_id" \
              -d @<(jq -n --arg tag "$release_tag" --arg target "$target_commit" --arg body "$body" '{tag_name:$tag,target_commitish:$target,name:$tag,body:$body}') >/dev/null
          else
            curl -s -X POST \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "$api_base/releases" \
              -d @<(jq -n --arg tag "$release_tag" --arg target "$target_commit" --arg body "$body" '{tag_name:$tag,target_commitish:$target,name:$tag,body:$body,draft:false,prerelease:false}') >/dev/null
          fi

          echo "hourly-latest release updated" >> "$GITHUB_STEP_SUMMARY"
