name: Proxy Pipeline

'on':
  schedule:
    - cron: '0 */1 * * *'
  workflow_dispatch:
    inputs:
      countries:
        description: 'Whitespace-separated country filters (optional)'
        required: false
      providers_allow:
        description: 'Comma-separated provider allow-list (optional)'
        required: false
      limit:
        description: 'Relay limit override (optional)'
        required: false
      verify:
        description: 'Run proxy verification after pipeline'
        required: false
        default: false
        type: boolean
      emit_canonical:
        description: 'Emit canonical Mullvad JSON artifact'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  actions: read
  packages: write
  pages: write
  id-token: write

jobs:
  proxy-pipeline:
    concurrency:
      group: mullvad-relay-pipeline
      cancel-in-progress: false
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up uv
        uses: astral-sh/setup-uv@v2

      - name: Install dependencies
        run: uv sync

      - name: Resolve pipeline arguments
        id: resolve
        shell: bash
        run: |
          args=("--no-cache" "--output-dir" "build" "--verbose")

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ -n "${{ github.event.inputs.countries }}" ]]; then
              args+=("--countries" "${{ github.event.inputs.countries }}")
            fi
            if [[ -n "${{ github.event.inputs.providers_allow }}" ]]; then
              args+=("--providers-allow" "${{ github.event.inputs.providers_allow }}")
            fi
            if [[ -n "${{ github.event.inputs.limit }}" ]]; then
              args+=("--limit" "${{ github.event.inputs.limit }}")
            fi
            if [[ '${{ github.event.inputs.emit_canonical }}' == 'true' ]]; then
              args+=("--emit-canonical-json")
            fi
          fi

          printf 'args=%s\n' "${args[*]}" >> "$GITHUB_OUTPUT"
          printf 'Pipeline arguments: %s\n' "${args[*]}"

          verify="false"
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            verify="true"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" && '${{ github.event.inputs.verify }}' == 'true' ]]; then
            verify="true"
          fi
          printf 'verify=%s\n' "$verify" >> "$GITHUB_OUTPUT"

          # carry verification sample size (default 5 for scheduled runs)
          verify_limit=5
          printf 'verify_limit=%s\n' "$verify_limit" >> "$GITHUB_OUTPUT"

          if [[ -n "$GITHUB_RUN_ATTEMPT" && "$GITHUB_RUN_ATTEMPT" -gt 1 ]]; then
            echo "Run attempt $GITHUB_RUN_ATTEMPT waiting for prior execution to finish" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Run relay pipeline
        run: uv run python build_relay_list.py ${{ steps.resolve.outputs.args }}

      - name: Run verification probes
        if: steps.resolve.outputs.verify == 'true'
        run: |
          uv run python scripts/verify_proxies.py --json build/mullvad_relays.json --limit ${{ steps.resolve.outputs.verify_limit }}

      - name: Export CSV artifact
        run: uv run python scripts/export_relays_csv.py build/mullvad_relays.json build/mullvad_relays.csv

      - name: Generate manifest
        env:
          PIPELINE_TRIGGER: ${{ github.event_name }}
          PIPELINE_RUN_ID: ${{ github.run_id }}
          PIPELINE_RUN_NUMBER: ${{ github.run_number }}
          INPUT_COUNTRIES: ${{ github.event.inputs.countries }}
          INPUT_PROVIDERS_ALLOW: ${{ github.event.inputs.providers_allow }}
          INPUT_LIMIT: ${{ github.event.inputs.limit }}
          INPUT_VERIFY: ${{ github.event.inputs.verify }}
          INPUT_EMIT_CANONICAL: ${{ github.event.inputs.emit_canonical }}
          VERIFY_ENABLED: ${{ steps.resolve.outputs.verify }}
          VERIFY_LIMIT: ${{ steps.resolve.outputs.verify_limit }}
        run: |
          uv run python - <<'PY'
          from pathlib import Path
          import json
          import os
          from mullvad.output import write_manifest

          relays_path = Path("build/mullvad_relays.json")
          relays = json.loads(relays_path.read_text(encoding="utf-8"))

          metadata = {
              "trigger": os.environ.get("PIPELINE_TRIGGER", "unknown"),
              "run_id": os.environ.get("PIPELINE_RUN_ID"),
              "run_number": os.environ.get("PIPELINE_RUN_NUMBER"),
          }
          if metadata["trigger"] == "workflow_dispatch":
              metadata["inputs"] = {
                  "countries": os.environ.get("INPUT_COUNTRIES", ""),
                  "providers_allow": os.environ.get("INPUT_PROVIDERS_ALLOW", ""),
                  "limit": os.environ.get("INPUT_LIMIT", ""),
                  "verify": os.environ.get("INPUT_VERIFY", ""),
                  "emit_canonical": os.environ.get("INPUT_EMIT_CANONICAL", ""),
              }
          else:
              metadata["inputs"] = {}

          filters = {}
          if os.environ.get("INPUT_COUNTRIES"):
              filters["countries"] = os.environ.get("INPUT_COUNTRIES")
          if os.environ.get("INPUT_PROVIDERS_ALLOW"):
              filters["providers_allow"] = os.environ.get("INPUT_PROVIDERS_ALLOW")
          if os.environ.get("INPUT_LIMIT"):
              filters["limit"] = os.environ.get("INPUT_LIMIT")

          write_manifest(
              relays,
              Path("build/manifest.json"),
              filters=filters,
              verification={
                  "enabled": os.environ.get("VERIFY_ENABLED", "false") == "true",
                  "limit": int(os.environ.get("VERIFY_LIMIT", "0") or 0),
              },
              artifacts={
                  "json": relays_path,
                  "text": Path("build/mullvad_relays.txt"),
                  "pac": Path("build/mullvad_relays.pac"),
                  "csv": Path("build/mullvad_relays.csv"),
              },
              metadata=metadata,
          )
          PY

      - name: Generate checksums
        working-directory: build
        run: |
          set -euo pipefail
          sha256sum mullvad_relays.json mullvad_relays.txt mullvad_relays.pac mullvad_relays.csv manifest.json > SHA256SUMS
          sha256sum -c SHA256SUMS

      - name: Package OCI bundle
        run: |
          tar -czf build/relay-artifacts.tar.gz -C build mullvad_relays.json mullvad_relays.txt mullvad_relays.pac mullvad_relays.csv manifest.json SHA256SUMS

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mullvad-relay-artifacts
          path: |
            build/mullvad_relays.json
            build/mullvad_relays.txt
            build/mullvad_relays.pac
            build/mullvad_relays.csv
            build/manifest.json
            build/SHA256SUMS
            build/relay-artifacts.tar.gz
          retention-days: 7

      - name: Summarise run
        env:
          PIPELINE_TRIGGER: ${{ github.event_name }}
          RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          ARTIFACT_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts
          VERIFY_FLAG: ${{ steps.resolve.outputs.verify }}
          INPUT_COUNTRIES: ${{ github.event.inputs.countries }}
          INPUT_PROVIDERS_ALLOW: ${{ github.event.inputs.providers_allow }}
          INPUT_LIMIT: ${{ github.event.inputs.limit }}
        shell: bash
        run: |
          relay_count=$(jq 'length' build/mullvad_relays.json)
          {
            echo "### Proxy Pipeline Summary"
            echo "- Trigger: \\`$PIPELINE_TRIGGER\\`"
            echo "- Relay count: $relay_count"
            if [[ -n "$INPUT_COUNTRIES" || -n "$INPUT_PROVIDERS_ALLOW" || -n "$INPUT_LIMIT" ]]; then
              echo "- Filter overrides:"
              [[ -n "$INPUT_COUNTRIES" ]] && echo "  - Countries: $INPUT_COUNTRIES"
              [[ -n "$INPUT_PROVIDERS_ALLOW" ]] && echo "  - Providers allow: $INPUT_PROVIDERS_ALLOW"
              [[ -n "$INPUT_LIMIT" ]] && echo "  - Limit: $INPUT_LIMIT"
            fi
            if [[ "$VERIFY_FLAG" == "true" ]]; then
              echo "- Verification: enabled (see workflow logs for results)"
            else
              echo "- Verification: disabled"
            fi
            echo "- Artifact bundle: [View artifacts]($ARTIFACT_URL)"
            echo "- Workflow run: [View run]($RUN_URL)"
          } >> "$GITHUB_STEP_SUMMARY"
  publish-artifacts:
    needs: proxy-pipeline
    if: github.ref == 'refs/heads/main' && needs.proxy-pipeline.result == 'success'
    runs-on: ubuntu-latest
    environment:
      name: github-pages
    strategy:
      max-parallel: 1
    steps:
      - name: Guard publication credentials
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ -z "$GITHUB_TOKEN" ]]; then
            echo "GITHUB_TOKEN is required for publication" >&2
            exit 1
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Download artifacts
        id: artifacts
        uses: actions/download-artifact@v4
        with:
          name: mullvad-relay-artifacts
          path: publish

      - name: Configure git
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email '41898282+github-actions[bot]@users.noreply.github.com'

      - name: Recency guard
        id: guard
        env:
          CURR_RUN: ${{ github.run_number }}
          CURR_ATTEMPT: ${{ github.run_attempt }}
        run: |
          set -euo pipefail
          git fetch origin proxy-artifacts:proxy-artifacts || true
          prev_run=0
          prev_attempt=0
          if git show proxy-artifacts:run_info.json > /tmp/prev_run_info.json 2>/dev/null; then
            prev_run=$(jq -r '.run_number // 0' /tmp/prev_run_info.json)
            prev_attempt=$(jq -r '.run_attempt // 0' /tmp/prev_run_info.json)
          fi
          if (( CURR_RUN < prev_run )) || { (( CURR_RUN == prev_run )) && (( CURR_ATTEMPT <= prev_attempt )); }; then
            echo "Stale run: previous ${prev_run}/${prev_attempt} newer or equal to ${CURR_RUN}/${CURR_ATTEMPT}; skipping publish" | tee -a "$GITHUB_STEP_SUMMARY"
            echo "proceed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "proceed=true" >> "$GITHUB_OUTPUT"

      - name: Prepare publication branch
        id: publish
        if: steps.guard.outputs.proceed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_ACTOR: ${{ github.actor }}
        run: |
          git remote set-url origin https://$GITHUB_ACTOR:$GITHUB_TOKEN@github.com/$GITHUB_REPOSITORY.git
          git fetch origin proxy-artifacts:proxy-artifacts || git branch proxy-artifacts
          git checkout proxy-artifacts || git checkout -b proxy-artifacts
          rm -f relays.json relays.txt relays.pac relays.csv manifest.json SHA256SUMS relay-artifacts.tar.gz run_info.json

          artifact_dir=$(find publish -type f -name 'mullvad_relays.json' -printf '%h' -quit)
          if [[ -z "$artifact_dir" ]]; then
            echo "Artifact files not found after download" >&2
            exit 1
          fi
          cp "$artifact_dir/mullvad_relays.json" relays.json
          cp "$artifact_dir/mullvad_relays.txt" relays.txt
          cp "$artifact_dir/mullvad_relays.pac" relays.pac
          cp "$artifact_dir/mullvad_relays.csv" relays.csv
          cp "$artifact_dir/manifest.json" manifest.json
          cp "$artifact_dir/SHA256SUMS" SHA256SUMS
          cp "$artifact_dir/relay-artifacts.tar.gz" relay-artifacts.tar.gz

          sha256sum -c SHA256SUMS

          jq -n --arg rn "${{ github.run_number }}" --arg ra "${{ github.run_attempt }}" --arg rid "${{ github.run_id }}" --arg ts "$(date -u +%FT%TZ)" '{run_number: ($rn|tonumber), run_attempt: ($ra|tonumber), run_id: $rid, published_at: $ts}' > run_info.json
          git add relays.json relays.txt relays.pac relays.csv manifest.json
          git add SHA256SUMS relay-artifacts.tar.gz run_info.json
          # Only commit when proxy list outputs change; ignore manifest-only deltas
          if git diff --cached --quiet -- relays.json relays.txt relays.pac relays.csv; then
            echo "No proxy list changes detected; skipping publication commit" >> "$GITHUB_STEP_SUMMARY"
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            git commit -m "chore(publish): update relay artifacts"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Push publication branch
        if: steps.guard.outputs.proceed == 'true' && steps.publish.outputs.changed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_ACTOR: ${{ github.actor }}
        run: |
          git push --force-with-lease origin HEAD:proxy-artifacts
          echo "Published artifacts to proxy-artifacts branch" >> "$GITHUB_STEP_SUMMARY"

      - name: Upload Pages artifact
        if: steps.guard.outputs.proceed == 'true' && steps.publish.outputs.changed == 'true'
        run: |
          mkdir -p pages
          cp relays.json relays.txt relays.pac relays.csv manifest.json SHA256SUMS pages/
          cp relay-artifacts.tar.gz pages/

      - name: Upload Pages
        if: steps.guard.outputs.proceed == 'true' && steps.publish.outputs.changed == 'true'
        uses: actions/upload-pages-artifact@v4
        with:
          path: pages

      - name: Deploy Pages
        if: steps.guard.outputs.proceed == 'true' && steps.publish.outputs.changed == 'true'
        uses: actions/deploy-pages@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup ORAS
        if: steps.guard.outputs.proceed == 'true' && steps.publish.outputs.changed == 'true'
        uses: oras-project/setup-oras@v1

      - name: Push OCI artifact to ghcr
        id: oci
        if: steps.guard.outputs.proceed == 'true' && steps.publish.outputs.changed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          set -euo pipefail
          oras version
          echo "$GITHUB_TOKEN" | oras login ghcr.io -u "$GITHUB_ACTOR" --password-stdin
          tag="ghcr.io/${GITHUB_REPOSITORY}/mullvad-relays:run-${{ github.run_number }}-${{ github.run_attempt }}"
          oras push "$tag" relay-artifacts.tar.gz:application/gzip
          echo "tag=$tag" >> "$GITHUB_OUTPUT"

      - name: Update hourly release with assets
        if: steps.guard.outputs.proceed == 'true' && steps.publish.outputs.changed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          set -euo pipefail

          target_commit=$(git rev-parse HEAD)
          release_tag="hourly-latest"
          repo_name=${GITHUB_REPOSITORY#*/}
          pages_url="https://${GITHUB_REPOSITORY_OWNER}.github.io/${repo_name}/"
          oci_tag="${{ steps.oci.outputs.tag }}"
          verify_status=$(jq -r '.verification.enabled' manifest.json)
          body=$(cat <<'EOF'
          ### Hourly Proxy Pipeline
          - Workflow run: RUN_URL
          - Pages bundle: PAGES_URL
          - OCI artifact: OCI_TAG
          - Verification: VERIFY_STATUS
          EOF
          )
          body=${body/RUN_URL/$RUN_URL}
          body=${body/PAGES_URL/$pages_url}
          body=${body/OCI_TAG/${oci_tag:-n/a}}
          body=${body/VERIFY_STATUS/$verify_status}

          if gh release view "$release_tag" >/dev/null 2>&1; then
            gh release upload "$release_tag" relays.json relays.txt relays.pac relays.csv manifest.json SHA256SUMS relay-artifacts.tar.gz --clobber
            gh release edit "$release_tag" --target "$target_commit" --notes "$body"
          else
            gh release create "$release_tag" relays.json relays.txt relays.pac relays.csv manifest.json SHA256SUMS relay-artifacts.tar.gz --target "$target_commit" --notes "$body" --title "$release_tag"
          fi

          echo "hourly-latest release updated with assets" >> "$GITHUB_STEP_SUMMARY"
